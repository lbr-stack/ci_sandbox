name: Performance Benchmark

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  merge_group:

permissions:
  contents: read
  pull-requests: read

jobs:
  compute-baseline:
    name: Compute Performance Baseline
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run compute
        run: compute

      - name: Upload performance result
        uses: actions/upload-artifact@v4
        with:
          name: performance-result-${{ github.sha }}
          path: performance_result.json
          retention-days: 90

  compute-baseline-main:
    name: Compute Performance Baseline on Main
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}

      - name: Get base SHA
        id: base-sha
        run: echo "BASE_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Run compute
        run: compute

      - name: Upload performance result
        uses: actions/upload-artifact@v4
        with:
          name: performance-result-${{ steps.base-sha.outputs.BASE_SHA }}
          path: performance_result.json
          retention-days: 90


  evaluate:
    name: Evaluate Against Baseline
    runs-on: ubuntu-latest
    needs: [compute-baseline, compute-baseline-main]
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'merge_group') && needs.compute-baseline.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check for skip-performance-check label
        id: check-label
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SKIP_EVAL="false"
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For pull_request events, check labels directly
            LABELS='${{ toJSON(github.event.pull_request.labels.*.name) }}'
            if echo "$LABELS" | grep -q "skip-performance-check"; then
              echo "Label 'skip-performance-check' found on PR"
              SKIP_EVAL="true"
            fi
          elif [ "${{ github.event_name }}" == "merge_group" ]; then
            # For merge_group events, extract PR number from head_ref and check its labels
            # head_ref format is typically: refs/heads/gh-readonly-queue/{base_branch}/pr-{number}-{sha}
            HEAD_REF="${{ github.event.merge_group.head_ref }}"
            echo "Merge group head_ref: $HEAD_REF"
            
            # Extract PR number from the head_ref
            if [[ "$HEAD_REF" =~ pr-([0-9]+)- ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "Extracted PR number: $PR_NUMBER"
              
              # Use GitHub CLI to fetch PR labels
              PR_LABELS=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' 2>/dev/null || echo "")
              
              if echo "$PR_LABELS" | grep -q "skip-performance-check"; then
                echo "Label 'skip-performance-check' found on PR #$PR_NUMBER (from merge group)"
                SKIP_EVAL="true"
              else
                echo "Label 'skip-performance-check' not found on PR #$PR_NUMBER"
              fi
            else
              echo "Could not extract PR number from head_ref: $HEAD_REF"
            fi
          fi
          
          echo "skip_eval=$SKIP_EVAL" >> $GITHUB_OUTPUT
          echo "Skip evaluation: $SKIP_EVAL"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download candidate result
        uses: actions/download-artifact@v4
        with:
          name: performance-result-${{ github.sha }}
          path: ./candidate

      - name: Download baseline result
        uses: actions/download-artifact@v4
        with:
          name: performance-result-${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}
          path: ./baseline

      - name: Evaluate performance
        if: steps.check-label.outputs.skip_eval != 'true'
        run: evaluate ./baseline/performance_result.json ./candidate/performance_result.json

      - name: Skip evaluation (label present)
        if: steps.check-label.outputs.skip_eval == 'true'
        run: |
          echo "⚠️  Performance evaluation skipped due to 'skip-performance-check' label"
          echo "The evaluation step was bypassed and will not block merging"
